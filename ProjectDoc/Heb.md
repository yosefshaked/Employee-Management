# תיק פרויקט: מערכת ניהול שכר ועובדים

**גרסה: 1.3.1**
**תאריך עדכון אחרון: 2025-09-13**

## 1. חזון ומטרה

מטרת הפרויקט היא לספק פתרון אפליקטיבי, נוח ויעיל לניהול תשלומי שכר לעובדים, כתחליף לקובץ אקסל שהיה מועד לטעויות. המערכת מותאמת אישית לצרכים של עסק עם שני סוגי עובדים עיקריים: עובדים שעתיים ומדריכים המקבלים תשלום פר-סשן.

**דרישות מפתח:**
- ממשק פשוט ואינטואיטיבי בעברית.
- יכולת להגדיר תעריפים דינמיים ומשתנים לאורך זמן.
- ניהול גמיש של סוגי שירותים (סשנים) שהמדריכים יכולים לבצע.
- דוחות מדויקים ואינטראקטיביים.
- שמירה על דיוק היסטורי של נתונים פיננסיים.

---

## 2. ארכיטקטורה וטכנולוגיות

המערכת בנויה בארכיטקטורת שרת-לקוח מודרנית, ארוזה כאפליקציית דסקטופ עצמאית.

*   **מעטפת אפליקציית דסקטופ:**
    *   **Framework:** Electron
    *   **כלי אריזה:** electron-builder
    *   **תכונות:** כולל Launcher מותאם אישית לפתיחת האפליקציה בחלון משלה או בדפדפן ברירת המחדל של המשתמש.

*   **Frontend (צד לקוח):** אפליקציית Single Page Application (SPA) שנבנתה באמצעות:
    *   **Framework:** React
    *   **ניתוב:** React Router (`HashRouter` לתאימות עם דסקטופ)
    *   **כלי בנייה:** Vite
    *   **עיצוב:** Tailwind CSS
    *   **ספריית רכיבים:** shadcn/ui

*   **Backend ובסיס נתונים:**
    *   **פלטפורמה:** Supabase (Backend-as-a-Service)
    *   **בסיס נתונים:** PostgreSQL
    *   **API:** נוצר אוטומטית על ידי Supabase (PostgREST).

*   **ניהול תצורה:**
    *   מפתחות ה-API מנוהלים באמצעות קובץ `.env` מקומי לאבטחה, מה שמבטיח שמידע רגיש לא נשמר במערכת ניהול הגרסאות.

---

## 3. מבנה בסיס הנתונים (Database Schema)

זהו לב המערכת. בסיס הנתונים מורכב מארבע טבלאות מרכזיות:

### 3.1. טבלת `Employees`
מכילה מידע כללי על כל עובד.

| עמודה | סוג | תיאור | אילוצים |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | מזהה ייחודי אוטומטי | **Primary Key** |
| `name` | `text` | שם מלא של העובד | Not NULL |
| `employee_type`| `text` | סוג עובד ('hourly', 'instructor', 'global') | Not NULL |
| `current_rate`| `numeric`| תעריף שעתי או חודשי נוכחי | |
| `working_days` | `jsonb` | מערך של ימי עבודה (למשל `["SUN","MON"]`) | ברירת מחדל: `["SUN","MON","TUE","WED","THU"]` |
| `is_active` | `boolean`| האם העובד פעיל כרגע | Default: `true` |
| ... | ... | שדות נוספים: `employee_id`, `phone`, `email`, `start_date`, `notes` | |

### 3.2. טבלת `Services`
מכילה את הרשימה הדינמית של שירותים/סשנים שמדריכים יכולים לבצע.

| עמודה | סוג | תיאור | אילוצים |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | מזהה ייחודי אוטומטי | **Primary Key** |
| `name` | `text` | שם השירות (למשל, "רכיבה טיפולית 30 דק'") | Not NULL |
| `duration_minutes`| `int8` | משך השירות בדקות (לצורך חישוב שעות) | |
| `payment_model`| `text` | מודל תשלום ('fixed_rate' או 'per_student') | Not NULL |
| `color` | `text` | קוד צבע הקסדצימלי (למשל, `#8B5CF6`) לתצוגה בממשק | |

### 3.3. טבלת `RateHistory`
הטבלה הקריטית ביותר. שומרת את יומן התעריפים ההיסטורי לכל עובד ושירות.

| עמודה | סוג | תיאור | אילוצים |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | מזהה ייחודי אוטומטי | **Primary Key** |
| `employee_id` | `uuid` | מצביע לטבלת `Employees` | **Foreign Key** |
| `service_id` | `uuid` | מצביע לטבלת `Services` | **Foreign Key** |
| `rate` | `numeric` | סכום התעריף | Not NULL |
| `effective_date`| `date` | התאריך שממנו התעריף הזה נכנס לתוקף | Not NULL |
| `notes` | `text` | הערות על שינוי התעריף | |
| **אילוץ ייחודיות משולב** | `UNIQUE` | על העמודות: `employee_id`, `service_id`, `effective_date` | |

### 3.4. טבלת `WorkSessions`
יומן העבודה. כל שורה מייצגת סשן עבודה שהושלם.

| עמודה | סוג | תיאור | אילוצים |
| :--- | :--- | :--- | :--- |
| `id` | `uuid` | מזהה ייחודי אוטומטי | **Primary Key** |
| `employee_id` | `uuid` | מצביע לטבלת `Employees` | **Foreign Key** |
| `service_id` | `uuid` | מצביע לטבלת `Services` (למדריכים) | **Foreign Key** |
| `date` | `date` | תאריך ביצוע העבודה | Not NULL |
| `entry_type` | `text` | 'session', 'hours', 'adjustment', 'paid_leave' | Not NULL |
| `hours` | `numeric` | מספר שעות או ימים (כאשר רלוונטי) | |
| `sessions_count`| `int8` | מספר מפגשים (למדריכים) | |
| `students_count`| `int8` | מספר תלמידים (למודל `per_student`) | |
| `rate_used` | `numeric`| "תמונת מצב" של התעריף שהיה בשימוש בזמן החישוב | |
| `total_payment`| `numeric`| "תמונת מצב" של הסכום הסופי שחושב | |

#### כללי חישוב ב-WorkSessions

- `rate_used` נטען מטבלת `RateHistory` בכל יצירה או עדכון. מדריכים מחשבים לפי `(employee_id, service_id, date)`; עובדים שעתיים וגלובליים לפי `(employee_id, date)`.
- עבור רישומי מדריכים `service_id` הוא חובה. אם אין תעריף תקף לתאריך – הפעולה נחסמת עם הודעת שגיאה.
- `effectiveWorkingDays(employee, month)` סופר את ימי החודש בהם היום בשבוע כלול ב-`employee.working_days`. אם התוצאה היא `0` – השמירה נחסמת עם הודעה ברורה.
- `total_payment` מחושב ונשמר בכל שורה:
  - מדריכים: `sessions_count * students_count * rate_used` (או ללא תלמידים כאשר התשלום אינו פר תלמיד).
  - עובדים שעתיים: `hours * rate_used`.
  - עובדים גלובליים: `(rate_used / effectiveWorkingDays(employee, month)) * (days_count || 1)`.
  - חופשה בתשלום: אותו תעריף יומי כמו לעובד גלובלי, נשמר עם `entry_type='paid_leave'` ו-`notes='paid_leave'`.
- סיכומי חודש ודוחות מתבססים אך ורק על סכימת `total_payment` משורות `WorkSessions` ללא תוספות ידניות.
- היעדרות ללא תשלום = אין שורה. חופשה בתשלום נרשמת כשורה נפרדת מסוג `paid_leave`.

### מצב הזנה מרובה

ניתן להפעיל מצב **"בחר תאריכים להזנה מרובה"** בטבלת ההזנה ולסמן מספר תאים. לאחר הזנת התאריך הראשון תופיע שאלה: "להעתיק את מה שהזנת הרגע?". בחירה ב-"כן" תעתיק את הערכים ליום הבא; בחירה ב-"לא" תפתח טופס ריק.

### ייבוא CSV בעברית

מודל הדבקת CSV (אופציונלי) מקבל כותרות בעברית וממפה אותן לשדות הפנימיים:
`תאריך`→`date`, `סוג רישום`→`entry_type`, `שירות`→`service_name`, `שעות`→`hours`, `מספר שיעורים`→`sessions_count`, `מספר תלמידים`→`students_count`.
השורות עוברות ולידציה ונשמרות כרגיל בטבלת `WorkSessions`.

---

## 4. החלטות ארכיטקטוניות ומסקנות (Lessons Learned)

במהלך הפיתוח התקבלו מספר החלטות מפתח שעיצבו את המערכת:

1.  **שימוש בטבלת `RateHistory` נפרדת:** במקום להוסיף עמודות תעריפים לטבלת `Employees`.
    *   **היגיון:** זה מספק גמישות אינסופית להוספת שירותים חדשים מבלי לשנות את סכמת בסיס הנתונים. והכי חשוב, זה שומר על **היסטוריית תעריפים מדויקת**, שחיונית לחישובים רטרואקטיביים.
    *   **מסקנה:** דיוק היסטורי בנתונים פיננסיים גובר על הפשטות של מבנה נתונים "שטוח".

2.  **שימוש ב-`upsert` עם `onConflict` משולב:** כדי למנוע רשומות תעריפים כפולות לאותו היום, הגדרנו אילוץ ייחודיות על השילוב של `employee_id`, `service_id`, ו-`effective_date`.
    *   **היגיון:** זה מאפשר לנו להשתמש בפקודת `upsert` יעילה ש"דורסת" שינויים שנעשו באותו היום, ובכך מונעת "בלגן" בבסיס הנתונים ושומרת על "מקור אמת אחד" לכל יום נתון.
    *   **מסקנה:** שימוש נכון באילוצים (constraints) בבסיס הנתונים מפשט את הלוגיקה בקוד ומונע באגים.

3.  **הפיכת רכיבים ל"חכמים" ועצמאיים:** באג שבו טופס עריכת העובד לא הציג תעריפים מעודכנים נפתר על ידי הפיכת `EmployeeForm` לרכיב שאחראי להביא את הנתונים העדכניים שלו בעצמו, במקום להסתמך על מידע שעלול להיות "ישן" מהרכיב האב.
    *   **מסקנה:** חיוני לנהל את ה-state בחוכמה ולהבטיח שרכיבים תמיד עובדים עם המידע העדכני ביותר שהם צריכים.

4.  **תעדוף חווית המשתמש (UX):** התלבטנו רבות לגבי התנהגות טפסים, במיוחד במעבר בין סוגי עובדים.
    *   **ההחלטה:** במקום איפוס טופס מלא, יישמנו "איפוס חלקי חכם" והוספנו `AlertDialog` מעוצב כדי לתת למשתמש שליטה מלאה על פעולות שעלולות לגרום לאיבוד מידע.
    *   **מסקנה:** חווית משתמש טובה דורשת חשיבה על מקרי קצה והימנעות מהתנהגויות אוטומטיות שעלולות לתסכל את המשתמש.

5.  **ניהול מרוכז של היסטוריית תעריפים:** רכיב `RateHistoryManager` הייעודי מאפשר להוסיף או לערוך רשומות היסטוריית תעריפים ישירות מתוך טופס העובד; מחיקה אינה זמינה כדי לשמור על עקבות.
    *   **מסקנה:** ריכוז עריכת התעריפים במקום אחד שומר על נתוני השכר עקביים ושקופים.

---

## 5. מדריך התקנה ופריסה

מדריך זה מיועד למפתח (או AI) חדש שמצטרף לפרויקט וצריך להקים את סביבת הפיתוח מאפס.

### הגדרת סביבת פיתוח

1.  **שכפל את המאגר:** `git clone [כתובת המאגר]`
2.  **התקן תלויות:** `npm install`
3.  **הקם פרויקט ב-Supabase:**
    *   צור פרויקט חדש ב-`supabase.com`.
    *   צור את 4 הטבלאות (`Employees`, `Services`, `RateHistory`, `WorkSessions`) כפי שמפורט בסעיף 3.
    *   ודא שכל ה-`Primary Keys`, `Foreign Keys`, וה-`Constraints` מוגדרים כראוי.
4.  **צור קובץ סביבה:**
    *   בתיקייה הראשית של הפרויקט, צור קובץ חדש בשם `.env`.
    *   הוסף את פרטי הגישה ל-Supabase לקובץ זה:
        ----------------------------------------------------------------
        VITE_SUPABASE_URL=https://<your-project-id>.supabase.co
        VITE_SUPABASE_ANON_KEY=<your-anon-key>
        ----------------------------------------------------------------
    *   **חשוב:** קובץ ה-`.env` נמצא ב-`.gitignore` ולא יישמר בגיט.
5.  **הרץ את אפליקציית הפיתוח:**
    -----------------------
    npm run electron:dev
    -----------------------
    פעולה זו תפעיל את האפליקציה בחלון דסקטופ עם טעינה חמה (hot-reloading).

### בנייה ל-Production

1.  **הרץ את פקודת הבנייה:**
    -----------------------
    npm run electron:build
    -----------------------
2.  פקודה זו תבצע:
    *   בנייה של אפליקציית ה-React לתיקיית `/dist`.
    *   אריזה של האפליקציה עם Electron לקובץ התקנה הפעלה.
3.  קובץ ההתקנה/האפליקציה הסופי ימוקם בתיקיית `/release` (שנוצרת מחוץ לתיקיית הפרויקט).